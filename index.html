<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Approve</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/parakeet/480/document.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/parakeet/480/document.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Safety Approve">
    <!-- Google Fonts - Prompt (Thai) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        :root{
            --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;
            --secondary:#06b6d4;--secondary-light:#22d3ee;
            --success:#10b981;--success-light:#34d399;
            --warning:#f59e0b;--warning-light:#fbbf24;
            --danger:#ef4444;--danger-light:#f87171;
            --bg:#f0f4f8;--white:#ffffff;--text:#1e293b;--text-muted:#64748b;
            --border:#e2e8f0;--card:#ffffff;--sidebar-bg:#1e293b;--sidebar-text:#cbd5e1;
            --shadow:0 1px 3px rgba(0,0,0,0.08),0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg:0 10px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.06);
            --shadow-xl:0 20px 40px -8px rgba(0,0,0,0.12);
            --table-header:#1e293b;
            --radius:14px;--radius-lg:20px;--radius-xl:24px
        }

        [data-theme="dark"]{
            --primary:#818cf8;--primary-dark:#6366f1;--primary-light:#a5b4fc;
            --bg:#0f172a;--white:#1e293b;--text:#f1f5f9;--text-muted:#94a3b8;
            --border:#334155;--card:#1e293b;--sidebar-bg:#0f172a;--sidebar-text:#94a3b8;
            --table-header:#0f172a;
            --shadow:0 1px 3px rgba(0,0,0,0.3);--shadow-lg:0 10px 25px rgba(0,0,0,0.4);
            --shadow-xl:0 20px 40px rgba(0,0,0,0.5)
        }

        body{
            font-family:'Prompt',sans-serif;
            background:var(--white);min-height:100vh;
            display:flex;align-items:center;justify-content:center;
            color:var(--text);transition:background .3s,color .3s
        }

        /* ===== SweetAlert z-index fix ===== */
        .swal2-container{z-index:9999!important}

        /* ===== Flatpickr Consistent Width Fix ===== */
        .flatpickr-input{width:100%!important;height:48px!important;line-height:48px!important}
        .flatpickr-calendar{font-family:'Prompt',sans-serif}

        /* ===== iOS Date/Time Input Fix ===== */
        input[type="date"],input[type="time"]{-webkit-appearance:none;appearance:none}
        select,input,textarea{font-size:16px!important}

        /* ===== Login ===== */
        .login-container{
            background:var(--card);padding:48px 40px;border-radius:var(--radius-xl);
            box-shadow:var(--shadow-xl);width:90%;max-width:420px;border:1px solid var(--border)
        }
        .login-header{text-align:center;margin-bottom:32px}
        .login-icon{width:80px;height:80px;margin-bottom:16px;border-radius:20px}
        .login-header h1{color:var(--text);font-size:26px;font-weight:700;margin-bottom:8px}
        .login-header p{color:var(--text-muted);font-size:14px;font-weight:300}

        /* ===== Form ===== */
        .form-group{margin-bottom:20px;position:relative}
        .form-group label{display:block;color:var(--text);margin-bottom:8px;font-weight:500;font-size:14px}
        .password-wrapper{position:relative}
        .form-group input,.form-group textarea,.form-group select{
            width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:12px;
            font-size:16px!important;transition:all .3s;outline:none;
            font-family:'Prompt',sans-serif;background:var(--card);color:var(--text);
            height:48px;line-height:1.2;-webkit-appearance:none;appearance:none
        }
        .form-group textarea{height:auto;min-height:80px}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{
            border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,0.12)
        }
        .form-group input:read-only,.form-group textarea:read-only,.form-group select:disabled{
            background:var(--bg);cursor:not-allowed;opacity:.7
        }
        .toggle-password{
            position:absolute;right:14px;top:50%;transform:translateY(-50%);
            background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;display:flex
        }
        .toggle-password:hover{color:var(--primary)}
        .toggle-password svg{width:20px;height:20px}

        /* ===== Request Warning Banner ===== */
        .request-warning{
            margin-top:8px;padding:10px 14px;border-radius:10px;font-size:13px;font-weight:500;
            line-height:1.5;display:none;animation:fadeIn .3s ease
        }
        .request-warning.show{display:block}
        .request-warning.warning-blue{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
        .request-warning.warning-orange{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa}
        .request-warning.warning-red{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
        @keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

        /* ===== Phone with Call Button ===== */
        .phone-wrapper{display:flex;gap:8px;align-items:center}
        .phone-wrapper input{flex:1}
        .btn-call{
            width:48px;height:48px;min-width:48px;border:none;border-radius:12px;
            background:linear-gradient(135deg,var(--success),#059669);color:#fff;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:all .3s;padding:0
        }
        .btn-call:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(16,185,129,0.4)}
        .btn-call svg{width:22px;height:22px}

        /* ===== Buttons ===== */
        .btn{
            width:100%;padding:14px 24px;border:none;border-radius:12px;font-size:15px;font-weight:600;
            cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;
            gap:10px;font-family:'Prompt',sans-serif
        }
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(99,102,241,0.35)}
        .btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(16,185,129,0.35)}
        .btn-danger{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff}
        .btn-danger:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(239,68,68,0.35)}
        .btn-warning{background:linear-gradient(135deg,var(--warning),#d97706);color:#fff}
        .btn-warning:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(245,158,11,0.35)}
        .btn:disabled{opacity:.7;cursor:not-allowed;transform:none!important}
        .spinner{width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:none}
        .spinner.active{display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* ===== Main System ===== */
        .main-system{display:none;width:100%;min-height:100vh;background:var(--bg)}

        /* ===== Sidebar - RIGHT SIDE ===== */
        .sidebar{position:fixed;top:0;right:-300px;width:300px;height:100vh;background:var(--sidebar-bg);z-index:1000;transition:right .3s;display:flex;flex-direction:column}
        .sidebar.active{right:0}
        .sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;opacity:0;visibility:hidden;transition:all .3s}
        .sidebar-overlay.active{opacity:1;visibility:visible}
        .sidebar-header{padding:24px;border-bottom:1px solid rgba(255,255,255,0.08)}
        .sidebar-profile{display:flex;align-items:center;gap:14px}
        /* ★ Profile วงกลม ★ */
        .sidebar-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-light)}
        .sidebar-user-info h3{color:#fff;font-size:16px;font-weight:600;margin-bottom:4px}
        .sidebar-user-info p{color:var(--sidebar-text);font-size:12px;font-weight:300}
        .sidebar-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;margin-top:6px}
        .badge-admin{background:rgba(16,185,129,0.15);color:var(--success-light)}
        .badge-user{background:rgba(6,182,212,0.15);color:var(--secondary-light)}
        .sidebar-menu{flex:1;padding:16px 12px;overflow-y:auto}
        .sidebar-menu-item{
            display:flex;align-items:center;gap:14px;padding:14px 16px;color:var(--sidebar-text);
            transition:all .3s;cursor:pointer;border:none;background:none;width:100%;
            font-size:14px;font-weight:500;font-family:'Prompt',sans-serif;border-radius:12px;margin-bottom:4px;text-align:left
        }
        .sidebar-menu-item:hover{background:rgba(255,255,255,0.08);color:#fff}
        .sidebar-menu-item.active{background:var(--primary);color:#fff}
        .sidebar-menu-item svg{width:20px;height:20px;flex-shrink:0}
        .sidebar-footer{padding:16px 12px;border-top:1px solid rgba(255,255,255,0.08)}
        .sidebar-logout{
            display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;
            background:rgba(239,68,68,0.12);color:var(--danger-light);border:none;border-radius:12px;
            font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;font-family:'Prompt',sans-serif
        }
        .sidebar-logout:hover{background:var(--danger);color:#fff}
        .sidebar-logout svg{width:18px;height:18px}

        /* ===== Navbar (fixed สำหรับ PWA iOS) ===== */
        .navbar{
            background:var(--card);padding:12px 24px;box-shadow:var(--shadow);
            display:flex;justify-content:space-between;align-items:center;
            position:fixed;top:0;left:0;right:0;z-index:100;border-bottom:1px solid var(--border)
        }
        .navbar-spacer{height:72px;flex-shrink:0}
        .navbar-left{display:flex;align-items:center;gap:16px}
        /* ★ Logo กรอบขนาดเท่าระฆัง 46x46 ★ */
        .navbar-logo-wrap{
            width:46px;height:46px;border-radius:var(--radius);
            border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
            background:var(--bg);flex-shrink:0;overflow:hidden;transition:all .3s
        }
        .navbar-logo-wrap:hover{border-color:var(--primary)}
        .navbar-logo-wrap img{width:28px;height:28px}
        /* ★ Profile วงกลม & ขนาดเท่าระฆัง 46x46 ★ */
        .navbar-avatar{
            width:46px;height:46px;border-radius:50%;object-fit:cover;cursor:pointer;
            border:2px solid var(--border);transition:all .3s;flex-shrink:0
        }
        .navbar-avatar:hover{border-color:var(--primary);transform:scale(1.05)}
        .navbar-brand{display:flex;align-items:center;gap:12px;min-width:0}
        .navbar-brand h2{color:var(--text);font-size:20px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .navbar-right{display:flex;align-items:center;gap:12px}

        /* ===== Notification Bell ===== */
        .notification-btn{
            position:relative;width:46px;height:46px;border-radius:var(--radius);border:2px solid var(--border);
            background:var(--bg);color:var(--text);cursor:pointer;display:flex;align-items:center;
            justify-content:center;transition:all .3s;flex-shrink:0
        }
        .notification-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .notification-btn svg{width:22px;height:22px}
        .notification-badge{
            position:absolute;top:-6px;right:-6px;min-width:22px;height:22px;
            background:var(--danger);color:#fff;font-size:11px;font-weight:700;
            border-radius:11px;display:flex;align-items:center;justify-content:center;
            padding:0 6px;border:2px solid var(--card);animation:pulse 2s infinite
        }
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .notification-badge.hidden{display:none}

        /* ===== Notification Dropdown ===== */
        .notification-wrapper{position:relative}
        .notification-dropdown{
            position:absolute;top:calc(100% + 16px);right:0;width:380px;max-height:480px;
            background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);
            border:1px solid var(--border);z-index:1001;display:none;overflow:hidden
        }
        .notification-dropdown.active{display:block;animation:fadeIn .2s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .notification-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .notification-header h3{font-size:16px;font-weight:600;color:var(--text)}
        .notification-clear{font-size:12px;color:var(--primary);cursor:pointer;background:none;border:none;font-family:'Prompt',sans-serif;font-weight:500}
        .notification-list{max-height:400px;overflow-y:auto}
        .notification-item{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;cursor:pointer;transition:background .2s}
        .notification-item:hover{background:var(--bg)}
        .notification-item:last-child{border-bottom:none}
        .notification-item.unread{background:rgba(99,102,241,0.04)}
        .notification-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        /* ★ สีไอคอนแจ้งเตือนที่เข้ากับ theme ★ */
        .notification-icon.icon-new{background:rgba(6,182,212,0.12);color:var(--secondary)}
        .notification-icon.icon-approved{background:rgba(16,185,129,0.12);color:var(--success)}
        .notification-icon.icon-rejected{background:rgba(239,68,68,0.12);color:var(--danger)}
        .notification-icon.icon-edit{background:rgba(245,158,11,0.12);color:var(--warning)}
        .notification-icon.icon-info{background:rgba(99,102,241,0.12);color:var(--primary)}
        .notification-icon svg{width:20px;height:20px}
        .notification-content{flex:1;min-width:0}
        .notification-content p{font-size:13px;color:var(--text);margin-bottom:4px;line-height:1.5;font-weight:400}
        .notification-content span{font-size:11px;color:var(--text-muted);font-weight:300}
        .notification-empty{padding:40px 20px;text-align:center;color:var(--text-muted)}
        .notification-empty svg{width:48px;height:48px;margin-bottom:12px;opacity:.3}
        .notification-empty p{font-weight:400}

        /* ===== Content ===== */
        .content{padding:24px;max-width:1400px;margin:0 auto}
        .content-header{margin-bottom:24px}
        .content-header h1{color:var(--text);font-size:26px;font-weight:700;margin-bottom:8px}
        .content-header p{color:var(--text-muted);font-size:14px;font-weight:300}

        /* ===== Table Controls ===== */
        .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:16px;flex-wrap:wrap}
        .search-box{position:relative;flex:1;max-width:420px}
        .search-box input{
            width:100%;padding:14px 16px 14px 50px;border:2px solid var(--border);border-radius:var(--radius);
            font-size:14px!important;background:var(--card);color:var(--text);transition:all .3s;font-family:'Prompt',sans-serif
        }
        .search-box input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,0.12);outline:none}
        .search-box svg{position:absolute;left:18px;top:50%;transform:translateY(-50%);width:20px;height:20px;color:var(--text-muted)}
        .btn-add-new{
            padding:14px 28px;background:linear-gradient(135deg,var(--success),#059669);color:#fff;
            border:none;border-radius:var(--radius);font-size:14px;font-weight:600;cursor:pointer;
            display:flex;align-items:center;gap:10px;transition:all .3s;
            font-family:'Prompt',sans-serif;white-space:nowrap
        }
        .btn-add-new:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(16,185,129,0.35)}
        .btn-add-new svg{width:20px;height:20px}

        /* ===== Data Card & Table ===== */
        .data-card{background:var(--card);border-radius:var(--radius-xl);box-shadow:var(--shadow-lg);overflow:hidden;border:1px solid var(--border)}
        .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
        table{width:100%;border-collapse:collapse;min-width:900px}
        /* ★ หัวตารางและข้อมูล padding/line-height เท่ากัน ★ */
        th,td{padding:16px 20px;line-height:1.4;white-space:nowrap;font-size:14px}
        th{
            background:var(--table-header);color:#fff;
            text-align:left;font-weight:600;
            text-transform:uppercase;letter-spacing:.5px
        }
        th:first-child{border-radius:0;padding-left:24px}
        th:last-child{border-radius:0;padding-right:24px}
        td{
            color:var(--text);
            border-bottom:1px solid var(--border);vertical-align:middle;font-weight:400
        }
        td:first-child{padding-left:24px;font-weight:600}
        td:last-child{padding-right:24px}
        tbody tr{transition:all .2s}
        tbody tr:hover{background:rgba(99,102,241,0.03)}
        tbody tr:last-child td{border-bottom:none}

        /* ===== Status Badges ===== */
        .status-badge{
            padding:8px 18px;border-radius:24px;font-size:12px;font-weight:600;
            display:inline-flex;align-items:center;gap:8px
        }
        .status-badge::before{content:'';width:8px;height:8px;border-radius:50%}
        .status-pending{background:rgba(245,158,11,0.12);color:var(--warning)}
        .status-pending::before{background:var(--warning)}
        .status-approved{background:rgba(16,185,129,0.12);color:var(--success)}
        .status-approved::before{background:var(--success)}
        .status-rejected{background:rgba(239,68,68,0.12);color:var(--danger)}
        .status-rejected::before{background:var(--danger)}

        /* ===== Detail Button ===== */
        .btn-detail{
            padding:10px 20px;background:var(--primary);color:#fff;border:none;border-radius:10px;
            font-size:13px;font-weight:500;cursor:pointer;transition:all .3s;display:inline-flex;
            align-items:center;gap:8px;font-family:'Prompt',sans-serif;white-space:nowrap
        }
        .btn-detail:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .btn-detail svg{width:16px;height:16px}

        /* ===== Loading & Empty ===== */
        .loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--text-muted)}
        .loading-spinner{width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
        .no-data{text-align:center;padding:80px 20px;color:var(--text-muted)}
        .no-data svg{width:80px;height:80px;margin-bottom:16px;opacity:.3}

        /* ===== Pagination ===== */
        .pagination-container{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-top:1px solid var(--border);flex-wrap:wrap;gap:16px}
        .pagination-info{color:var(--text-muted);font-size:14px;font-weight:400}
        .pagination{display:flex;gap:4px;align-items:center;flex-wrap:nowrap}
        .pagination button{
            min-width:40px;height:40px;padding:0 12px;border:1px solid var(--border);
            background:var(--card);color:var(--text);border-radius:10px;cursor:pointer;
            font-size:14px;font-weight:500;transition:all .3s;font-family:'Prompt',sans-serif
        }
        .pagination button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button:disabled{opacity:.5;cursor:not-allowed}

        /* ===== Modal ===== */
        .modal{
            display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(15,23,42,0.6);z-index:2000;align-items:center;justify-content:center;
            padding:20px;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)
        }
        .modal-content{
            background:var(--card);border-radius:var(--radius-xl);width:90%;max-width:700px;
            box-shadow:var(--shadow-xl);animation:modalSlideIn .3s;margin:auto;
            max-height:90vh;display:flex;flex-direction:column;overflow:hidden
        }
        @keyframes modalSlideIn{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{
            display:flex;justify-content:space-between;align-items:center;
            padding:24px 32px;border-bottom:2px solid var(--border);flex-shrink:0
        }
        .modal-header h2{color:var(--text);font-size:20px;font-weight:700}
        .close-btn{
            width:42px;height:42px;border-radius:var(--radius);border:none;background:var(--bg);
            color:var(--text-muted);font-size:24px;cursor:pointer;display:flex;align-items:center;
            justify-content:center;transition:all .3s
        }
        .close-btn:hover{background:var(--danger);color:#fff}
        .modal-body{padding:24px 32px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .btn-group{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:24px}
        .btn-group-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:24px}

        /* ===== FCM Permission Banner ===== */
        .fcm-banner{
            background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(6,182,212,0.08));
            border:1px solid var(--border);border-radius:var(--radius);
            padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:14px
        }
        .fcm-banner.hidden{display:none}
        .fcm-banner-icon{
            width:42px;height:42px;border-radius:12px;background:var(--primary);color:#fff;
            display:flex;align-items:center;justify-content:center;flex-shrink:0
        }
        .fcm-banner-icon svg{width:22px;height:22px}
        .fcm-banner-text{flex:1}
        .fcm-banner-text p{font-size:14px;color:var(--text);margin-bottom:4px;font-weight:500}
        .fcm-banner-text span{font-size:12px;color:var(--text-muted);font-weight:300}
        .fcm-banner-btn{
            padding:10px 20px;background:var(--primary);color:#fff;border:none;border-radius:10px;
            font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap;
            font-family:'Prompt',sans-serif
        }
        .fcm-banner-btn:hover{background:var(--primary-dark)}

        /* ===== Responsive ===== */
        @media(max-width:768px){
            .content{padding:16px}
            .content-header h1{font-size:22px}
            .table-controls{flex-direction:column;align-items:stretch}
            .search-box{max-width:none}
            .btn-add-new{width:100%;justify-content:center}
            /* ★ Fix form-row on mobile ★ */
            .form-row,.btn-group,.btn-group-3{grid-template-columns:1fr}
            .modal-content{max-height:95vh;width:95%}
            .modal-header{padding:20px 24px}
            .modal-body{padding:20px 24px}
            /* ★ Fix flatpickr input width on mobile ★ */
            .modal-body .form-group input,
            .modal-body .form-group textarea,
            .modal-body .form-group select{
                width:100%!important;max-width:100%!important;min-width:0!important
            }
            .pagination-container{flex-direction:column;align-items:center;padding:16px;gap:10px}
            .pagination{justify-content:center;flex-wrap:nowrap;gap:3px}
            .pagination button{min-width:36px;height:36px;padding:0 8px;font-size:13px;border-radius:8px}
            .notification-dropdown{position:fixed!important;top:72px!important;left:16px!important;right:16px!important;width:auto!important}
            .navbar-brand h2{font-size:16px;max-width:150px}
            .fcm-banner{flex-direction:column;text-align:center}
            th,td{padding:14px 12px}
            th:first-child,td:first-child{padding-left:14px}
            th:last-child,td:last-child{padding-right:14px}
        }
        @media(max-width:480px){
            .login-container{padding:32px 24px}
            .navbar{padding:12px 16px}
            .navbar-left{gap:10px}
            .navbar-brand h2{font-size:14px;max-width:120px}
            .pagination button{min-width:32px;height:32px;padding:0 6px;font-size:12px}
        }
    </style>
</head>
<body>
    <!-- ===== Login Page ===== -->
    <div class="login-container" id="loginPage">
        <div class="login-header">
            <img src="https://img.icons8.com/parakeet/480/document.png" alt="Icon" class="login-icon">
            <h1>Safety Approve</h1>
            <p>กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label>ชื่อผู้ใช้</label>
                <input type="text" id="username" required placeholder="กรอกชื่อผู้ใช้" autocomplete="username">
            </div>
            <div class="form-group">
                <label>รหัสผ่าน</label>
                <div class="password-wrapper">
                    <input type="password" id="password" required placeholder="กรอกรหัสผ่าน" style="padding-right:48px" autocomplete="current-password">
                    <button type="button" class="toggle-password" onclick="togglePassword('password')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" id="loginBtn">
                <span class="spinner" id="loginSpinner"></span>
                <span id="loginBtnText">เข้าสู่ระบบ</span>
            </button>
        </form>
    </div>

    <!-- ===== Main System ===== -->
    <div class="main-system" id="mainSystem">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Sidebar - RIGHT -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-profile">
                    <img id="sidebarAvatar" src="https://img.icons8.com/color/96/user.png" class="sidebar-avatar">
                    <div class="sidebar-user-info">
                        <h3 id="sidebarUserName">-</h3>
                        <p id="sidebarPosition">-</p>
                        <span class="sidebar-badge badge-user" id="sidebarBadge">User</span>
                    </div>
                </div>
            </div>
            <nav class="sidebar-menu">
                <button class="sidebar-menu-item active" onclick="closeSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    หน้าหลัก
                </button>
                <button class="sidebar-menu-item" onclick="openUserProfileModal();closeSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    ข้อมูลส่วนตัว
                </button>
                <button class="sidebar-menu-item" onclick="toggleTheme();closeSidebar()">
                    <svg id="themeIconSidebar" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    <span id="themeTextSidebar">Dark Mode</span>
                </button>
            </nav>
            <div class="sidebar-footer">
                <button class="sidebar-logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    ออกจากระบบ
                </button>
            </div>
        </aside>

        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-left">
                <div class="navbar-brand">
                    <!-- ★ Logo มีกรอบขนาดเท่าระฆัง ★ -->
                    <div class="navbar-logo-wrap">
                        <img src="https://img.icons8.com/parakeet/480/document.png" alt="Logo">
                    </div>
                    <h2>Safety Approve</h2>
                </div>
            </div>
            <div class="navbar-right">
                <div class="notification-wrapper">
                    <button class="notification-btn" onclick="toggleNotifications()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h3>การแจ้งเตือน</h3>
                            <button class="notification-clear" onclick="clearNotifications()">ล้างทั้งหมด</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                                <p>ไม่มีการแจ้งเตือน</p>
                            </div>
                        </div>
                    </div>
                </div>
                <img id="navbarAvatar" src="https://img.icons8.com/color/96/user.png" class="navbar-avatar" onclick="toggleSidebar()">
            </div>
        </nav>
        <!-- ★ Spacer เพื่อชดเชย fixed navbar ★ -->
        <div class="navbar-spacer"></div>

        <!-- Content -->
        <div class="content">
            <div class="fcm-banner hidden" id="fcmBanner">
                <div class="fcm-banner-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                </div>
                <div class="fcm-banner-text">
                    <p>เปิดการแจ้งเตือนเพื่อรับข้อมูลอัปเดตแบบเรียลไทม์</p>
                    <span>คุณจะได้รับแจ้งเตือนเมื่อมีคำขอใหม่ หรือมีการอนุมัติ/ปฏิเสธ</span>
                </div>
                <button class="fcm-banner-btn" onclick="requestFCMPermission()">เปิดการแจ้งเตือน</button>
            </div>

            <div class="content-header">
                <h1>รายการคำขออนุญาต</h1>
                <p>จัดการคำขออนุญาตเติมน้ำมันและการดำเนินการต่างๆ</p>
            </div>
            <div class="table-controls">
                <div class="search-box">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="searchInput" placeholder="ค้นหา ID, สายการบิน, คำขออนุญาต..." oninput="handleSearch()">
                </div>
                <button class="btn-add-new" onclick="openAddModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    เพิ่มคำขอใหม่
                </button>
            </div>
            <div class="data-card">
                <div class="loading-container" id="loadingData"><div class="loading-spinner"></div><p>กำลังโหลดข้อมูล...</p></div>
                <div class="table-wrapper" id="tableWrapper" style="display:none">
                    <table>
                        <thead><tr><th>ID</th><th>วันที่บันทึก</th><th>คำขออนุญาต</th><th>สายการบิน</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="no-data" id="noData" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <p>ยังไม่มีข้อมูลคำขออนุญาต</p>
                </div>
                <div class="pagination-container" id="paginationContainer" style="display:none">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Add Modal ===== -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header"><h2>เพิ่มคำขออนุญาต</h2><button class="close-btn" onclick="closeAddModal()">&times;</button></div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="form-group"><label>1. คำขออนุญาต *</label>
                        <select id="requestType" required onchange="showRequestWarning(this.value,'addRequestWarning')">
                            <option value="">-- เลือกคำขออนุญาต --</option>
                            <option value="เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน">1) เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน</option>
                            <option value="เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน">2) เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน</option>
                            <option value="เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน">3) เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน</option>
                            <option value="ทดสอบเครื่องยนต์">4) ทดสอบเครื่องยนต์</option>
                            <option value="ติดเครื่องยนต์หนึ่งเครื่องยนต์">5) ติดเครื่องยนต์หนึ่งเครื่องยนต์</option>
                            <option value="ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน">6) ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน</option>
                        </select>
                        <div id="addRequestWarning" class="request-warning"></div>
                    </div>
                    <div class="form-group"><label>2. สายการบิน/ผู้ประกอบการ *</label><input type="text" id="airline" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>3. แบบอากาศยาน *</label><input type="text" id="aircraftType" required></div>
                        <div class="form-group"><label>4. เที่ยวบิน *</label><input type="text" id="flightNumber" required></div>
                    </div>
                    <div class="form-group"><label>5. วันที่ต้องการเติมน้ำมัน *</label><input type="text" id="refuelDate" required placeholder="เลือกวันที่" readonly></div>
                    <div class="form-row">
                        <div class="form-group"><label>6. เริ่มเวลา *</label><input type="text" id="startTime" required placeholder="เลือกเวลา" readonly></div>
                        <div class="form-group"><label>7. ถึงเวลา *</label><input type="text" id="endTime" required placeholder="เลือกเวลา" readonly></div>
                    </div>
                    <div class="form-group"><label>8. เหตุจำเป็น *</label><textarea id="reason" required rows="3"></textarea></div>
                    <div class="form-group"><label>9. มาตรการความปลอดภัย *</label><textarea id="safetyMeasures" required rows="3"></textarea></div>
                    <div class="form-group"><label>10. บุคคลที่สามารถติดต่อได้ *</label><input type="text" id="contactPerson" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>11. ตำแหน่ง *</label><input type="text" id="contactPosition" required></div>
                        <div class="form-group"><label>12. สังกัด *</label><input type="text" id="department" required></div>
                    </div>
                    <div class="form-group"><label>13. เบอร์โทรศัพท์ *</label><input type="tel" id="phoneNumber" required pattern="[0-9]{10}" placeholder="0812345678"></div>
                    <button type="submit" class="btn btn-primary"><span class="spinner" id="addSpinner"></span><span id="addBtnText">บันทึกข้อมูล</span></button>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== Detail Modal ===== -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header"><h2>รายละเอียดคำขออนุญาต</h2><button class="close-btn" onclick="closeDetailModal()">&times;</button></div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <!-- ===== User Profile Modal ===== -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ข้อมูลผู้ใช้งาน</h2><button class="close-btn" onclick="closeUserProfileModal()">&times;</button></div>
            <div class="modal-body" id="userProfileContent"></div>
        </div>
    </div>

<script>
// ==========================================
// Configuration
// ==========================================
const API_URL = 'https://script.google.com/macros/s/AKfycbxrd8fEuRnh419llp7ZpYaJc69hBaWSeMpZitJiyNrp8r7DgUzkoaRgX8yRrGDDmSqJyw/exec';

const firebaseConfig = {
  apiKey: "AIzaSyAY0vYjBf2Mc_p8z5eU1uR_2jujMk7zLTw",
  authDomain: "approve-safety-system.firebaseapp.com",
  projectId: "approve-safety-system",
  storageBucket: "approve-safety-system.firebasestorage.app",
  messagingSenderId: "602722012670",
  appId: "1:602722012670:web:62207d57b1f0f147e584af"
};

const VAPID_KEY = 'BERAn7OANYzrnkdVh-KTbGUUDwAkAuUrFP7E5b1qB_nLk9PFv-Uv2WrtM8cwzAKghV-NQ5Ip7AwxvKg0wQrdQRQ';

// ==========================================
// State
// ==========================================
let currentUser = null;
let allData = [];
let filteredData = [];
let fullDetailData = {};
let currentPage = 1;
let itemsPerPage = 10;
let autoRefreshInterval = null;
let previousDataCount = 0;
let previousDataSnapshot = {};
let notifications = [];
let unreadCount = 0;
let fcmInitialized = false;

// ==========================================
// Firebase Cloud Messaging (รองรับ iOS PWA)
// ==========================================
async function initFirebaseMessaging() {
    try {
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === 'YOUR_API_KEY') {
            console.log('Firebase not configured');
            checkNotificationBannerVisibility();
            return;
        }

        firebase.initializeApp(firebaseConfig);

        // ★ ลงทะเบียน Service Worker สำหรับ Background Notifications ★
        // สำคัญมากสำหรับ iOS PWA
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            try {
                swRegistration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', { scope: './' });
                console.log('Service Worker registered:', swRegistration.scope);

                // รอจน SW พร้อมใช้งาน
                await navigator.serviceWorker.ready;
                console.log('Service Worker ready');
            } catch (swErr) {
                console.log('SW registration failed:', swErr);
            }
        }

        const messaging = firebase.messaging();

        // ★ ใช้ SW ที่ลงทะเบียนแล้วกับ FCM ★
        if (swRegistration) {
            messaging.useServiceWorker(swRegistration);
        }

        fcmInitialized = true;

        // รับข้อความขณะ App เปิดอยู่ (Foreground)
        messaging.onMessage((payload) => {
            console.log('FCM Foreground message:', payload);
            const { title, body, icon } = payload.notification || {};
            const data = payload.data || {};

            addNotification(
                body || title || 'มีการอัปเดตใหม่',
                data.type || 'info',
                data.requestId || ''
            );
            showBrowserNotification(title, body, icon);
            loadAllData(true);
        });

        // รับข้อความจาก Service Worker เมื่อ user กดที่ notification
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'NOTIFICATION_CLICK') {
                    const reqId = event.data.data?.requestId;
                    if (reqId) {
                        loadAllData(false).then(() => {
                            if (fullDetailData[reqId]) viewDetail(reqId);
                        });
                    }
                }
            });
        }

        // ตรวจสอบ Permission
        if (Notification.permission === 'granted') {
            await getFCMToken(messaging);
        } else if (Notification.permission === 'default') {
            checkNotificationBannerVisibility();
        }

    } catch (e) {
        console.log('Firebase init error:', e);
        checkNotificationBannerVisibility();
    }
}

function checkNotificationBannerVisibility() {
    if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('fcmBanner').classList.remove('hidden');
    }
}

async function requestFCMPermission() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            document.getElementById('fcmBanner').classList.add('hidden');
            if (fcmInitialized) {
                const messaging = firebase.messaging();
                await getFCMToken(messaging);
            }
            addNotification('เปิดการแจ้งเตือนสำเร็จ', 'info', '');
            Swal.fire({ icon:'success', title:'เปิดการแจ้งเตือนแล้ว!', text:'คุณจะได้รับแจ้งเตือนเมื่อมีการอัปเดต', timer:2000, showConfirmButton:false, toast:true, position:'top-end' });
        } else {
            document.getElementById('fcmBanner').classList.add('hidden');
        }
    } catch (e) {
        console.log('Permission error:', e);
    }
}

async function getFCMToken(messaging) {
    try {
        // ★ ระบุ serviceWorkerRegistration เพื่อให้ iOS ทำงานถูกต้อง ★
        const swReg = await navigator.serviceWorker.getRegistration('./');
        const tokenOptions = { vapidKey: VAPID_KEY };
        if (swReg) tokenOptions.serviceWorkerRegistration = swReg;

        const token = await messaging.getToken(tokenOptions);
        if (token && currentUser) {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'saveFCMToken', userId: currentUser.id, token: token })
            });
            console.log('FCM Token saved');
        }
    } catch (e) {
        console.log('FCM Token error:', e);
    }
}

// ==========================================
// Browser Notification
// ==========================================
function showBrowserNotification(title, body, icon) {
    if ('Notification' in window && Notification.permission === 'granted') {
        try {
            const reg = navigator.serviceWorker?.controller;
            if (reg && navigator.serviceWorker.ready) {
                // ★ ใช้ Service Worker แสดง notification (รองรับ iOS PWA) ★
                navigator.serviceWorker.ready.then(r => {
                    r.showNotification(title || 'Safety Approve', {
                        body: body || 'มีการอัปเดตใหม่',
                        icon: icon || 'https://img.icons8.com/parakeet/480/document.png',
                        badge: 'https://img.icons8.com/parakeet/480/document.png',
                        vibrate: [200, 100, 200],
                        requireInteraction: true
                    });
                });
            } else {
                new Notification(title || 'Safety Approve', {
                    body: body || 'มีการอัปเดตใหม่',
                    icon: icon || 'https://img.icons8.com/parakeet/480/document.png'
                });
            }
        } catch (e) {
            console.log('Notification error:', e);
        }
    }
}

// ==========================================
// Sound Effects
// ==========================================
function playSound(t='success'){
    try{
        const c=new(window.AudioContext||window.webkitAudioContext)();
        const o=c.createOscillator();const g=c.createGain();
        o.connect(g);g.connect(c.destination);
        if(t==='success'){o.frequency.setValueAtTime(523.25,c.currentTime);o.frequency.setValueAtTime(659.25,c.currentTime+.1);o.frequency.setValueAtTime(783.99,c.currentTime+.2);g.gain.setValueAtTime(.3,c.currentTime);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.4);o.start();o.stop(c.currentTime+.4)}
        else if(t==='newData'){o.frequency.setValueAtTime(880,c.currentTime);o.frequency.setValueAtTime(1108.73,c.currentTime+.1);o.frequency.setValueAtTime(1318.51,c.currentTime+.2);g.gain.setValueAtTime(.25,c.currentTime);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.5);o.start();o.stop(c.currentTime+.5)}
        else{o.frequency.setValueAtTime(200,c.currentTime);o.frequency.setValueAtTime(150,c.currentTime+.15);g.gain.setValueAtTime(.3,c.currentTime);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.3);o.start();o.stop(c.currentTime+.3)}
    }catch(e){}
}

// ==========================================
// Theme
// ==========================================
function toggleTheme(){
    const h=document.documentElement;
    const n=h.getAttribute('data-theme')==='dark'?'light':'dark';
    h.setAttribute('data-theme',n);localStorage.setItem('theme',n);updateThemeIcons(n);
}
function updateThemeIcons(t){
    const moon='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
    const sun='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
    const e=document.getElementById('themeIconSidebar');
    if(e)e.innerHTML=t==='dark'?sun:moon;
    const ts=document.getElementById('themeTextSidebar');
    if(ts)ts.textContent=t==='dark'?'Light Mode':'Dark Mode';
}
function loadSavedTheme(){const t=localStorage.getItem('theme')||'light';document.documentElement.setAttribute('data-theme',t);updateThemeIcons(t)}

// ==========================================
// Sidebar
// ==========================================
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('active');document.getElementById('sidebarOverlay').classList.toggle('active')}
function closeSidebar(){document.getElementById('sidebar').classList.remove('active');document.getElementById('sidebarOverlay').classList.remove('active')}

// ==========================================
// Notifications (Bell)
// ==========================================
function toggleNotifications(){
    const dd=document.getElementById('notificationDropdown');
    dd.classList.toggle('active');
    if(dd.classList.contains('active')){unreadCount=0;updateNotificationBadge()}
}
function addNotification(message,type='info',requestId=''){
    const now=new Date();
    const timeStr=`${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    notifications.unshift({message,type,requestId,time:timeStr,unread:true});
    if(notifications.length>50)notifications.pop();
    unreadCount++;updateNotificationUI();updateNotificationBadge();
}
function updateNotificationBadge(){
    const b=document.getElementById('notificationBadge');
    if(unreadCount>0){b.textContent=unreadCount>99?'99+':unreadCount;b.classList.remove('hidden')}
    else{b.classList.add('hidden')}
}
function updateNotificationUI(){
    const l=document.getElementById('notificationList');
    if(notifications.length===0){
        l.innerHTML='<div class="notification-empty"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><p>ไม่มีการแจ้งเตือน</p></div>';
        return;
    }
    l.innerHTML=notifications.map(n=>{
        let iconClass='icon-info',iconSvg='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
        if(n.type==='new'){iconClass='icon-new';iconSvg='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>';}
        else if(n.type==='approved'){iconClass='icon-approved';iconSvg='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';}
        else if(n.type==='rejected'){iconClass='icon-rejected';iconSvg='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>';}
        else if(n.type==='edit'){iconClass='icon-edit';iconSvg='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>';}
        return `<div class="notification-item ${n.unread?'unread':''}" ${n.requestId?`onclick="viewDetail('${n.requestId}')"`:''}><div class="notification-icon ${iconClass}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">${iconSvg}</svg></div><div class="notification-content"><p>${n.message}</p><span>${n.time}</span></div></div>`;
    }).join('');
}
function clearNotifications(){notifications=[];unreadCount=0;updateNotificationUI();updateNotificationBadge()}

// ==========================================
// Utility
// ==========================================
function formatDateTime(d){
    if(!d)return'-';
    try{
        if(typeof d==='string'){
            if(d.includes('T')){const dt=new Date(d);return`${dt.getDate().toString().padStart(2,'0')}-${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getFullYear()} ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;}
            if(d.includes('/')&&d.includes(',')){const p=d.split(', '),dp=p[0].split('/'),tp=p[1].split(':');return`${dp[0].padStart(2,'0')}-${dp[1].padStart(2,'0')}-${dp[2]} ${tp[0].padStart(2,'0')}:${tp[1].padStart(2,'0')}`;}
        }return d;
    }catch(e){return d;}
}
function formatDateOnly(d){
    if(!d)return'';
    // Handle ISO date string: 2026-02-14T17:00:00.000Z
    if(typeof d==='string'&&d.includes('T')){
        const dt=new Date(d);
        if(!isNaN(dt)){const dd=String(dt.getDate()).padStart(2,'0'),mm=String(dt.getMonth()+1).padStart(2,'0'),yy=dt.getFullYear();return`${dd}/${mm}/${yy}`;}
    }
    // Handle Date object
    if(d instanceof Date||typeof d==='object'){
        try{const dt=new Date(d);if(!isNaN(dt)){const dd=String(dt.getDate()).padStart(2,'0'),mm=String(dt.getMonth()+1).padStart(2,'0'),yy=dt.getFullYear();return`${dd}/${mm}/${yy}`;}}catch(e){}
    }
    // Handle dd/mm/yyyy
    if(typeof d==='string'&&d.includes('/')){const p=d.split('/');if(p.length===3)return`${p[0].padStart(2,'0')}/${p[1].padStart(2,'0')}/${p[2]}`;}
    return String(d);
}
function formatTimeOnly(t){
    if(!t)return'';
    // Handle ISO time string: 1899-12-30T08:17:56.000Z
    if(typeof t==='string'&&t.includes('T')&&t.includes('1899')){
        const dt=new Date(t);
        if(!isNaN(dt)){const hh=String(dt.getUTCHours()).padStart(2,'0'),mi=String(dt.getUTCMinutes()).padStart(2,'0');return`${hh}:${mi}`;}
    }
    // Handle any ISO string with time
    if(typeof t==='string'&&t.includes('T')){
        const dt=new Date(t);
        if(!isNaN(dt)){const hh=String(dt.getUTCHours()).padStart(2,'0'),mi=String(dt.getUTCMinutes()).padStart(2,'0');return`${hh}:${mi}`;}
    }
    // Handle Date object
    if(t instanceof Date||typeof t==='object'){
        try{const dt=new Date(t);if(!isNaN(dt)){const hh=String(dt.getHours()).padStart(2,'0'),mi=String(dt.getMinutes()).padStart(2,'0');return`${hh}:${mi}`;}}catch(e){}
    }
    // Handle HH:mm
    if(typeof t==='string'&&t.match(/^\d{1,2}:\d{2}/)){const p=t.split(':');return`${p[0].padStart(2,'0')}:${p[1].padStart(2,'0')}`;}
    return String(t);
}

function togglePassword(i){
    const inp=document.getElementById(i);const btn=inp.parentElement.querySelector('.toggle-password');const isP=inp.type==='password';
    inp.type=isP?'text':'password';
    btn.innerHTML=isP
        ?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>'
        :'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>';
}

// ==========================================
// Init
// ==========================================
window.addEventListener('DOMContentLoaded',()=>{
    loadSavedTheme();updateNotificationUI();updateNotificationBadge();

    const s=sessionStorage.getItem('currentUser');
    if(s){currentUser=JSON.parse(s);showMainSystem();loadAllData();initFirebaseMessaging();}

    flatpickr("#refuelDate",{dateFormat:"d/m/Y",locale:"th"});
    flatpickr("#startTime",{enableTime:true,noCalendar:true,dateFormat:"H:i",time_24hr:true});
    flatpickr("#endTime",{enableTime:true,noCalendar:true,dateFormat:"H:i",time_24hr:true});

    document.addEventListener('click',e=>{
        if(!e.target.closest('.notification-btn')&&!e.target.closest('.notification-dropdown'))
            document.getElementById('notificationDropdown').classList.remove('active');
    });
});

// ==========================================
// Login
// ==========================================
document.getElementById('loginForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const u=document.getElementById('username').value,p=document.getElementById('password').value;
    const btn=document.getElementById('loginBtn'),sp=document.getElementById('loginSpinner'),tx=document.getElementById('loginBtnText');
    btn.disabled=true;sp.classList.add('active');tx.textContent='กำลังเข้าสู่ระบบ...';
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'login',username:u,password:p})});
        const res=await r.json();sp.classList.remove('active');
        if(res.success){
            currentUser=res.user;sessionStorage.setItem('currentUser',JSON.stringify(currentUser));
            playSound('success');
            await Swal.fire({icon:'success',title:'เข้าสู่ระบบสำเร็จ!',text:`ยินดีต้อนรับคุณ ${currentUser.name}`,timer:1500,showConfirmButton:false});
            btn.disabled=false;tx.textContent='เข้าสู่ระบบ';
            showMainSystem();loadAllData();initFirebaseMessaging();
        }else{
            playSound('error');Swal.fire({icon:'error',title:'เข้าสู่ระบบไม่สำเร็จ',text:res.message});
            btn.disabled=false;tx.textContent='เข้าสู่ระบบ';
        }
    }catch(err){
        sp.classList.remove('active');playSound('error');
        Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้'});
        btn.disabled=false;tx.textContent='เข้าสู่ระบบ';
    }
});

// ==========================================
// Main System
// ==========================================
function showMainSystem(){
    document.getElementById('loginPage').style.display='none';
    document.getElementById('mainSystem').style.display='block';
    document.body.style.alignItems='flex-start';document.body.style.background='var(--bg)';
    updateUserUI();startAutoRefresh();
}
function updateUserUI(){
    const url=currentUser.imageUrl&&currentUser.imageUrl.trim()!==''
        ?`https://drive.google.com/thumbnail?id=${currentUser.imageUrl}&sz=w200`
        :'https://img.icons8.com/color/96/user.png';
    document.getElementById('navbarAvatar').src=url;
    document.getElementById('sidebarAvatar').src=url;
    document.getElementById('sidebarUserName').textContent=currentUser.name;
    document.getElementById('sidebarPosition').textContent=currentUser.position;
    const b=document.getElementById('sidebarBadge');b.textContent=currentUser.status;
    b.className=currentUser.status?.toLowerCase()==='admin'?'sidebar-badge badge-admin':'sidebar-badge badge-user';
}
function startAutoRefresh(){if(autoRefreshInterval)clearInterval(autoRefreshInterval);autoRefreshInterval=setInterval(()=>loadAllData(true),30000)}
function stopAutoRefresh(){if(autoRefreshInterval){clearInterval(autoRefreshInterval);autoRefreshInterval=null}}

// ==========================================
// Data Loading
// ==========================================
async function loadAllData(isAuto=false){
    const ld=document.getElementById('loadingData'),tw=document.getElementById('tableWrapper'),nd=document.getElementById('noData');
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'getAllRequestDetails'})});
        const res=await r.json();
        if(res.success){
            const newDataMap={};res.data.forEach(i=>newDataMap[i.ID]=i);
            if(isAuto&&previousDataCount>0){
                res.data.forEach(item=>{
                    if(!previousDataSnapshot[item.ID]){
                        addNotification(`คำขอใหม่ ${item.ID} - ${item.สายการบินหรือผู้ประกอบการ||''}`, 'new', item.ID);
                        showBrowserNotification('คำขอใหม่',`${item.ID} - ${item.สายการบินหรือผู้ประกอบการ||''}`);
                        playSound('newData');
                    }
                });
                res.data.forEach(item=>{
                    const prev=previousDataSnapshot[item.ID];
                    if(prev&&prev.Status!==item.Status){
                        if(item.Status==='Approved'){addNotification(`${item.ID} ได้รับการอนุมัติแล้ว`,'approved',item.ID);showBrowserNotification('อนุมัติคำขอ',`${item.ID} ได้รับการอนุมัติ`);}
                        else if(item.Status==='Rejected'){addNotification(`${item.ID} ถูกปฏิเสธ`,'rejected',item.ID);showBrowserNotification('ปฏิเสธคำขอ',`${item.ID} ถูกปฏิเสธ`);}
                        playSound('newData');
                    }
                });
            }
            previousDataCount=res.data.length;previousDataSnapshot=newDataMap;fullDetailData=newDataMap;
            allData=res.data.sort((a,b)=>parseInt(b.ID.replace('ID',''))-parseInt(a.ID.replace('ID','')));
            filteredData=[...allData];
            ld.style.display='none';
            if(allData.length===0){tw.style.display='none';nd.style.display='block';document.getElementById('paginationContainer').style.display='none';}
            else{tw.style.display='block';nd.style.display='none';displayData();}
        }
    }catch(e){if(!isAuto)ld.innerHTML='<div class="loading-container"><p style="color:var(--danger)">เกิดข้อผิดพลาดในการโหลดข้อมูล</p></div>';}
}

// ==========================================
// Search & Display
// ==========================================
function handleSearch(){
    const q=document.getElementById('searchInput').value.toLowerCase().trim();
    filteredData=!q?[...allData]:allData.filter(r=>
        (r.ID||'').toLowerCase().includes(q)||
        (r.คำขออนุญาต||'').toLowerCase().includes(q)||
        (r.สายการบินหรือผู้ประกอบการ||'').toLowerCase().includes(q)||
        (r.Status||'').toLowerCase().includes(q)
    );currentPage=1;displayData();
}
function displayData(){
    const tb=document.getElementById('tableBody');tb.innerHTML='';
    if(filteredData.length===0){
        tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px">ไม่พบข้อมูลที่ค้นหา</td></tr>';
        document.getElementById('paginationContainer').style.display='none';return;
    }
    const si=(currentPage-1)*itemsPerPage,pd=filteredData.slice(si,si+itemsPerPage);
    pd.forEach(r=>{
        const tr=document.createElement('tr');
        const sc=r.Status==='Approved'?'status-approved':r.Status==='Rejected'?'status-rejected':'status-pending';
        const st=r.Status==='Approved'?'อนุมัติแล้ว':r.Status==='Rejected'?'ปฏิเสธ':'รอดำเนินการ';
        tr.innerHTML=`
            <td><strong>${r.ID||''}</strong></td>
            <td>${formatDateTime(r.Timestamp)}</td>
            <td>${r.คำขออนุญาต||''}</td>
            <td>${r.สายการบินหรือผู้ประกอบการ||''}</td>
            <td><span class="status-badge ${sc}">${st}</span></td>
            <td><button class="btn-detail" onclick="viewDetail('${r.ID}')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> ดูรายละเอียด</button></td>`;
        tb.appendChild(tr);
    });
    document.getElementById('paginationContainer').style.display='flex';updatePagination();
}
function updatePagination(){
    const tp=Math.ceil(filteredData.length/itemsPerPage),si=(currentPage-1)*itemsPerPage+1,ei=Math.min(currentPage*itemsPerPage,filteredData.length);
    document.getElementById('paginationInfo').textContent=`แสดง ${si}-${ei} จาก ${filteredData.length} รายการ`;
    const pg=document.getElementById('pagination');pg.innerHTML='';
    const isMobile=window.innerWidth<=768;
    const range=isMobile?1:2;
    const pb=document.createElement('button');pb.innerHTML='&laquo;';pb.disabled=currentPage===1;
    pb.onclick=()=>{if(currentPage>1){currentPage--;displayData()}};pg.appendChild(pb);
    const sp=Math.max(1,currentPage-range),ep=Math.min(tp,currentPage+range);
    if(sp>1){const fb=document.createElement('button');fb.textContent='1';fb.onclick=()=>{currentPage=1;displayData()};pg.appendChild(fb);if(sp>2){const dt=document.createElement('button');dt.textContent='…';dt.disabled=true;pg.appendChild(dt)}}
    for(let i=sp;i<=ep;i++){const btn=document.createElement('button');btn.textContent=i;if(i===currentPage)btn.classList.add('active');btn.onclick=()=>{currentPage=i;displayData()};pg.appendChild(btn)}
    if(ep<tp){if(ep<tp-1){const dt=document.createElement('button');dt.textContent='…';dt.disabled=true;pg.appendChild(dt)}const lb=document.createElement('button');lb.textContent=tp;lb.onclick=()=>{currentPage=tp;displayData()};pg.appendChild(lb)}
    const nb=document.createElement('button');nb.innerHTML='&raquo;';nb.disabled=currentPage===tp||tp===0;
    nb.onclick=()=>{if(currentPage<tp){currentPage++;displayData()}};pg.appendChild(nb);
}

// ==========================================
// Detail View
// ==========================================
function viewDetail(id){
    document.getElementById('detailModal').style.display='flex';
    const d=fullDetailData[id];
    if(d)displayDetailForm(d);
    else document.getElementById('detailContent').innerHTML='<p style="text-align:center;color:var(--danger)">ไม่พบข้อมูล</p>';
}
function displayDetailForm(d){
    const isA=currentUser.status?.toLowerCase()==='admin';
    const isAp=d.Status==='Approved';const canE=isA&&!isAp;
    const ro=canE?'':'readonly';const di=canE?'':'disabled';
    const sc=d.Status==='Approved'?'status-approved':d.Status==='Rejected'?'status-rejected':'status-pending';
    const st=d.Status==='Approved'?'อนุมัติแล้ว':d.Status==='Rejected'?'ปฏิเสธ':'รอดำเนินการ';

    let h=`<form id="detailForm">
        <div class="form-group"><label>ID</label><input value="${d.ID}" readonly></div>
        <div class="form-group"><label>สถานะ</label><div><span class="status-badge ${sc}">${st}</span></div></div>
        <div class="form-group"><label>วันที่บันทึก</label><input value="${formatDateTime(d.Timestamp)}" readonly></div>
        <div class="form-group"><label>คำขออนุญาต</label>
            <select id="detailRequestType" ${di} onchange="showRequestWarning(this.value,'detailRequestWarning')">
                <option value="เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน" ${d.คำขออนุญาต==='เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน'?'selected':''}>1) เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน</option>
                <option value="เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน" ${d.คำขออนุญาต==='เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน'?'selected':''}>2) เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน</option>
                <option value="เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน" ${d.คำขออนุญาต==='เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน'?'selected':''}>3) เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน</option>
                <option value="ทดสอบเครื่องยนต์" ${d.คำขออนุญาต==='ทดสอบเครื่องยนต์'?'selected':''}>4) ทดสอบเครื่องยนต์</option>
                <option value="ติดเครื่องยนต์หนึ่งเครื่องยนต์" ${d.คำขออนุญาต==='ติดเครื่องยนต์หนึ่งเครื่องยนต์'?'selected':''}>5) ติดเครื่องยนต์หนึ่งเครื่องยนต์</option>
                <option value="ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน" ${d.คำขออนุญาต==='ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน'?'selected':''}>6) ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน</option>
            </select>
            <div id="detailRequestWarning" class="request-warning"></div>
        </div>
        <div class="form-group"><label>สายการบิน</label><input id="detailAirline" value="${d.สายการบินหรือผู้ประกอบการ||''}" ${ro}></div>
        <div class="form-row">
            <div class="form-group"><label>แบบอากาศยาน</label><input id="detailAircraftType" value="${d.แบบอากาศยาน||''}" ${ro}></div>
            <div class="form-group"><label>เที่ยวบิน</label><input id="detailFlightNumber" value="${d.เที่ยวบิน||''}" ${ro}></div>
        </div>
        <div class="form-group"><label>วันที่ต้องการ</label><input id="detailRefuelDate" value="${formatDateOnly(d.วันที่ต้องการเติมน้ำมัน)}" ${ro}></div>
        <div class="form-row">
            <div class="form-group"><label>เริ่มเวลา</label><input id="detailStartTime" value="${formatTimeOnly(d.เริ่มเวลา)}" ${ro}></div>
            <div class="form-group"><label>ถึงเวลา</label><input id="detailEndTime" value="${formatTimeOnly(d.ถึงเวลา)}" ${ro}></div>
        </div>
        <div class="form-group"><label>เหตุจำเป็น</label><textarea id="detailReason" ${ro}>${d.เหตุจำเป็นที่ต้องดำเนินการ||''}</textarea></div>
        <div class="form-group"><label>มาตรการความปลอดภัย</label><textarea id="detailSafetyMeasures" ${ro}>${d.ระบุมาตรการความปลอดภัยพอสังเขป||''}</textarea></div>
        <div class="form-group"><label>บุคคลที่ติดต่อ</label><input id="detailContactPerson" value="${d.บุคคลที่สามารถติดต่อได้||''}" ${ro}></div>
        <div class="form-row">
            <div class="form-group"><label>ตำแหน่ง</label><input id="detailContactPosition" value="${d.ตำแหน่ง||''}" ${ro}></div>
            <div class="form-group"><label>สังกัด</label><input id="detailDepartment" value="${d.สังกัด||''}" ${ro}></div>
        </div>
        <div class="form-group"><label>เบอร์โทร</label>
            <div class="phone-wrapper">
                <input id="detailPhoneNumber" value="${d.เบอร์โทรศัพท์ที่สามารถติดต่อได้||''}" ${ro}>
                <a href="tel:${d.เบอร์โทรศัพท์ที่สามารถติดต่อได้||''}" class="btn-call" title="โทรหา ${d.เบอร์โทรศัพท์ที่สามารถติดต่อได้||''}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                </a>
            </div>
        </div>`;

    if(isA||d.ผู้อนุมัติ){
        h+=`<div class="form-row">
            <div class="form-group"><label>ผู้อนุมัติ</label><input value="${d.ผู้อนุมัติ||currentUser.name}" readonly></div>
            <div class="form-group"><label>ตำแหน่งผู้อนุมัติ</label><input value="${d.ตำแหน่งผู้อนุมัติ||currentUser.position}" readonly></div>
        </div>`;
    }
    h+=`<div class="form-group"><label>หมายเหตุ</label><textarea id="detailNote" ${canE?'':'readonly'}>${d.หมายเหตุ||''}</textarea></div>`;
    if(isA&&!isAp){
        h+=`<div class="btn-group-3">
            <button type="button" class="btn btn-warning" onclick="handleSaveEdit('${d.ID}')"><span class="spinner" id="saveSpinner"></span><span id="saveText">บันทึกแก้ไข</span></button>
            <button type="button" class="btn btn-success" onclick="handleApprove('${d.ID}')"><span class="spinner" id="approveSpinner"></span><span id="approveText">อนุมัติ</span></button>
            <button type="button" class="btn btn-danger" onclick="handleReject('${d.ID}')"><span class="spinner" id="rejectSpinner"></span><span id="rejectText">ปฏิเสธ</span></button>
        </div>`;
    }
    h+='</form>';
    document.getElementById('detailContent').innerHTML=h;

    if(canE){
        flatpickr("#detailRefuelDate",{dateFormat:"d/m/Y",locale:"th"});
        flatpickr("#detailStartTime",{enableTime:true,noCalendar:true,dateFormat:"H:i",time_24hr:true});
        flatpickr("#detailEndTime",{enableTime:true,noCalendar:true,dateFormat:"H:i",time_24hr:true});
    }
    // ★ แสดง warning ตามประเภทคำขอที่เลือกอยู่ ★
    showRequestWarning(d.คำขออนุญาต,'detailRequestWarning');
}
function closeDetailModal(){document.getElementById('detailModal').style.display='none'}

// ==========================================
// Request Warning Messages
// ==========================================
function showRequestWarning(val,targetId){
    const el=document.getElementById(targetId);
    if(!el)return;
    
    const options=[
        'เติมน้ำมันขณะที่ไม่มีผู้โดยสารอยู่ในอากาศยาน',
        'เติมน้ำมันขณะที่มีผู้โดยสารอยู่ในอากาศยาน',
        'เติมน้ำมันขณะที่ผู้โดยสารขึ้นลงอากาศยาน'
    ];
    const opt4='ทดสอบเครื่องยนต์';
    const opt56=['ติดเครื่องยนต์หนึ่งเครื่องยนต์','ติดเครื่องยนต์หนึ่งเครื่องยนต์ขณะที่มีการเติมน้ำมันอากาศยาน'];
    
    if(options.includes(val)){
        el.className='request-warning warning-blue show';
        el.innerHTML='⚠️ กรุณาดำเนินการตามมาตรการความปลอดภัยของสายการบิน/ผู้ประกอบการ';
    }else if(val===opt4){
        el.className='request-warning warning-orange show';
        el.innerHTML='⚠️ กรุณาดำเนินการตามมาตรการความปลอดภัยของสายการบิน/ผู้ประกอบการ และประสานกองบิน 23 เพื่อขอความอนุเคราะห์พื้นที่สำหรับทดสอบเครื่องยนต์';
    }else if(opt56.includes(val)){
        el.className='request-warning warning-red show';
        el.innerHTML='⚠️ กรุณาดำเนินการตามมาตรการความปลอดภัยของสายการบิน/ผู้ประกอบการ และไม่มีอากาศยานจอดอยู่ทางฝั่งซ้ายของอากาศยานอย่างน้อย 1 หลุมจอด';
    }else{
        el.className='request-warning';
        el.innerHTML='';
    }
}

// ==========================================
// Actions
// ==========================================
async function handleSaveEdit(id){
    const sp=document.getElementById('saveSpinner'),tx=document.getElementById('saveText');
    sp?.classList.add('active');if(tx)tx.textContent='กำลังบันทึก...';
    const ud={
        requestType:document.getElementById('detailRequestType').value,
        airline:document.getElementById('detailAirline').value,
        aircraftType:document.getElementById('detailAircraftType').value,
        flightNumber:document.getElementById('detailFlightNumber').value,
        refuelDate:document.getElementById('detailRefuelDate').value,
        startTime:document.getElementById('detailStartTime').value,
        endTime:document.getElementById('detailEndTime').value,
        reason:document.getElementById('detailReason').value,
        safetyMeasures:document.getElementById('detailSafetyMeasures').value,
        contactPerson:document.getElementById('detailContactPerson').value,
        contactPosition:document.getElementById('detailContactPosition').value,
        department:document.getElementById('detailDepartment').value,
        phoneNumber:document.getElementById('detailPhoneNumber').value
    };
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'updateRequest',id,data:ud})});
        const res=await r.json();
        if(res.success){playSound('success');addNotification(`แก้ไขคำขอ ${id} สำเร็จ`,'edit',id);closeDetailModal();await Swal.fire({icon:'success',title:'สำเร็จ!',text:'บันทึกการแก้ไขเรียบร้อย',timer:1500,showConfirmButton:false});loadAllData();}
        else Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:res.message});
    }catch(e){Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:'ไม่สามารถบันทึกได้'})}
    finally{sp?.classList.remove('active');if(tx)tx.textContent='บันทึกแก้ไข'}
}
async function handleApprove(id){const r=await Swal.fire({title:'ยืนยันการอนุมัติ?',icon:'question',showCancelButton:true,confirmButtonColor:'#10b981',confirmButtonText:'อนุมัติ',cancelButtonText:'ยกเลิก'});if(r.isConfirmed)await doUpdateStatus(id,'Approved','')}
async function handleReject(id){const n=document.getElementById('detailNote').value.trim();if(!n){Swal.fire({icon:'warning',title:'กรุณากรอกหมายเหตุ',text:'จำเป็นต้องระบุเหตุผลในการปฏิเสธ'});return}const r=await Swal.fire({title:'ยืนยันการปฏิเสธ?',icon:'warning',showCancelButton:true,confirmButtonColor:'#ef4444',confirmButtonText:'ปฏิเสธ',cancelButtonText:'ยกเลิก'});if(r.isConfirmed)await doUpdateStatus(id,'Rejected',n)}

async function doUpdateStatus(id,status,note){
    const sp=document.getElementById(status==='Approved'?'approveSpinner':'rejectSpinner');
    const tx=document.getElementById(status==='Approved'?'approveText':'rejectText');
    sp?.classList.add('active');if(tx)tx.textContent='กำลังดำเนินการ...';
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'updateStatus',id,status,approver:{name:currentUser.name,position:currentUser.position},note})});
        const res=await r.json();
        if(res.success){
            playSound('success');
            const msg=status==='Approved'?`อนุมัติคำขอ ${id} เรียบร้อย`:`ปฏิเสธคำขอ ${id} เรียบร้อย`;
            addNotification(msg,status==='Approved'?'approved':'rejected',id);
            closeDetailModal();
            await Swal.fire({icon:'success',title:'สำเร็จ!',text:status==='Approved'?'อนุมัติคำขอเรียบร้อย':'ปฏิเสธคำขอเรียบร้อย',timer:1500,showConfirmButton:false});
            loadAllData();
        }else Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:res.message});
    }catch(e){Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด'})}
    finally{sp?.classList.remove('active');if(tx)tx.textContent=status==='Approved'?'อนุมัติ':'ปฏิเสธ'}
}

// ==========================================
// Add Request
// ==========================================
function openAddModal(){document.getElementById('addModal').style.display='flex'}
function closeAddModal(){document.getElementById('addModal').style.display='none';document.getElementById('addForm').reset();const w=document.getElementById('addRequestWarning');if(w){w.className='request-warning';w.innerHTML=''}}

document.getElementById('addForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const sp=document.getElementById('addSpinner'),tx=document.getElementById('addBtnText');
    sp.classList.add('active');tx.textContent='กำลังบันทึก...';
    const nd={
        requestType:document.getElementById('requestType').value,
        airline:document.getElementById('airline').value,
        aircraftType:document.getElementById('aircraftType').value,
        flightNumber:document.getElementById('flightNumber').value,
        refuelDate:document.getElementById('refuelDate').value,
        startTime:document.getElementById('startTime').value,
        endTime:document.getElementById('endTime').value,
        reason:document.getElementById('reason').value,
        safetyMeasures:document.getElementById('safetyMeasures').value,
        contactPerson:document.getElementById('contactPerson').value,
        contactPosition:document.getElementById('contactPosition').value,
        department:document.getElementById('department').value,
        phoneNumber:document.getElementById('phoneNumber').value
    };
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'addRequest',data:nd})});
        const res=await r.json();
        if(res.success){playSound('success');addNotification(`เพิ่มคำขอใหม่ ${res.id} สำเร็จ`,'new',res.id);previousDataCount++;closeAddModal();await Swal.fire({icon:'success',title:'สำเร็จ!',html:`บันทึกคำขออนุญาตเรียบร้อย<br><strong>เลขที่: ${res.id}</strong>`,timer:2000,showConfirmButton:false});loadAllData();}
        else Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:res.message});
    }catch(e){Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด'})}
    finally{sp.classList.remove('active');tx.textContent='บันทึกข้อมูล'}
});

// ==========================================
// User Profile
// ==========================================
function openUserProfileModal(){document.getElementById('userProfileModal').style.display='flex';displayUserProfile()}
function closeUserProfileModal(){document.getElementById('userProfileModal').style.display='none'}

function displayUserProfile(){
    const url=currentUser.imageUrl&&currentUser.imageUrl.trim()!==''
        ?`https://drive.google.com/thumbnail?id=${currentUser.imageUrl}&sz=w200`
        :'https://img.icons8.com/color/96/user.png';
    document.getElementById('userProfileContent').innerHTML=`
        <form id="userProfileForm">
            <div style="text-align:center;margin-bottom:24px">
                <div style="position:relative;display:inline-block">
                    <img id="profileImagePreview" src="${url}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--border)">
                    <label for="profileImageInput" style="position:absolute;bottom:-4px;right:-4px;background:var(--primary);color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    </label>
                    <input type="file" id="profileImageInput" accept="image/*" style="display:none" onchange="handleProfileImageChange(event)">
                </div>
            </div>
            <div class="form-group"><label>ID</label><input value="${currentUser.id}" readonly></div>
            <div class="form-group"><label>ชื่อผู้ใช้</label><input value="${currentUser.username}" readonly></div>
            <div class="form-group"><label>รหัสผ่าน</label><div class="password-wrapper"><input type="password" id="profilePassword" value="${currentUser.password||''}" readonly style="padding-right:48px"><button type="button" class="toggle-password" onclick="togglePassword('profilePassword')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button></div></div>
            <div class="form-group"><label>ชื่อ</label><input id="profileName" value="${currentUser.name}" readonly></div>
            <div class="form-group"><label>ตำแหน่ง</label><input id="profilePosition" value="${currentUser.position}" readonly></div>
            <div class="form-group"><label>สถานะ</label><input value="${currentUser.status}" readonly></div>
            <button type="button" class="btn btn-primary" onclick="enableEditProfile()">แก้ไขข้อมูล</button>
        </form>`;
}

function enableEditProfile(){
    ['profilePassword','profileName','profilePosition'].forEach(i=>document.getElementById(i).removeAttribute('readonly'));
    const f=document.getElementById('userProfileForm');
    f.querySelector('button[type="button"]').remove();
    const bg=document.createElement('div');bg.className='btn-group';
    bg.innerHTML='<button type="button" class="btn btn-success" onclick="saveUserProfile()"><span class="spinner" id="updateProfileSpinner"></span><span id="updateProfileText">บันทึกการแก้ไข</span></button><button type="button" class="btn btn-danger" onclick="displayUserProfile()">ยกเลิก</button>';
    f.appendChild(bg);
}

async function saveUserProfile(){
    const sp=document.getElementById('updateProfileSpinner'),tx=document.getElementById('updateProfileText');
    sp?.classList.add('active');if(tx)tx.textContent='กำลังบันทึก...';
    const p=document.getElementById('profilePassword').value.trim(),n=document.getElementById('profileName').value.trim(),po=document.getElementById('profilePosition').value.trim();
    if(!p||!n||!po){Swal.fire({icon:'warning',title:'กรุณากรอกข้อมูลให้ครบ'});sp?.classList.remove('active');if(tx)tx.textContent='บันทึกการแก้ไข';return}
    try{
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'updateUserProfile',id:currentUser.id,password:p,name:n,position:po})});
        const res=await r.json();
        if(res.success){currentUser.password=p;currentUser.name=n;currentUser.position=po;sessionStorage.setItem('currentUser',JSON.stringify(currentUser));updateUserUI();playSound('success');await Swal.fire({icon:'success',title:'สำเร็จ!',timer:1500,showConfirmButton:false});closeUserProfileModal()}
        else Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:res.message});
    }catch(e){Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด'})}
    finally{sp?.classList.remove('active');if(tx)tx.textContent='บันทึกการแก้ไข'}
}

async function handleProfileImageChange(e){
    const f=e.target.files[0];if(!f)return;
    if(!f.type.startsWith('image/')){Swal.fire({icon:'error',title:'ไฟล์ไม่ถูกต้อง'});return}
    if(f.size>2*1024*1024){Swal.fire({icon:'error',title:'ไฟล์ใหญ่เกินไป',text:'ขนาดไม่เกิน 2MB'});return}
    const reader=new FileReader();reader.onload=ev=>document.getElementById('profileImagePreview').src=ev.target.result;reader.readAsDataURL(f);
    Swal.fire({title:'กำลังอัปโหลด...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    try{
        const b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f)});
        const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'uploadProfileImage',userId:currentUser.id,fileName:f.name,mimeType:f.type,base64Data:b64.split(',')[1]})});
        const res=await r.json();
        if(res.success){currentUser.imageUrl=res.fileId;sessionStorage.setItem('currentUser',JSON.stringify(currentUser));updateUserUI();playSound('success');Swal.fire({icon:'success',title:'สำเร็จ!',timer:1500,showConfirmButton:false})}
        else Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:res.message});
    }catch(err){Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด'})}
    e.target.value='';
}

// ==========================================
// Logout
// ==========================================
async function logout(){
    closeSidebar();
    const r=await Swal.fire({title:'ออกจากระบบ?',icon:'question',showCancelButton:true,confirmButtonColor:'#ef4444',confirmButtonText:'ออกจากระบบ',cancelButtonText:'ยกเลิก'});
    if(r.isConfirmed){
        stopAutoRefresh();
        currentUser=null;previousDataCount=0;allData=[];filteredData=[];fullDetailData={};previousDataSnapshot={};notifications=[];unreadCount=0;
        sessionStorage.removeItem('currentUser');
        document.getElementById('mainSystem').style.display='none';
        document.getElementById('loginPage').style.display='block';
        document.body.style.alignItems='center';document.body.style.background='var(--white)';
        document.getElementById('loginForm').reset();
        updateNotificationUI();updateNotificationBadge();
        await Swal.fire({icon:'success',title:'ออกจากระบบแล้ว',timer:1000,showConfirmButton:false});
    }
}

// ==========================================
// Modal Click Outside
// ==========================================
window.onclick=e=>{
    ['addModal','detailModal','userProfileModal'].forEach(id=>{
        if(e.target===document.getElementById(id)){
            if(id==='addModal')closeAddModal();
            else if(id==='detailModal')closeDetailModal();
            else closeUserProfileModal();
        }
    });
};
</script>
</body>
</html>
